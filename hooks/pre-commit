#!/usr/bin/env bash
# pre-commit hook for .dotfiles repository
# Prevents accidental commits of state, cache, history, and secret files

set -e

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Critical patterns that should NEVER be committed
FORBIDDEN_PATTERNS=(
    # macOS artifacts
    "\.DS_Store$"
    "\.Trashes$"
    "\.Spotlight-V100$"
    "\.AppleDouble$"
    "\.LSOverride$"
    "\.apdisk$"

    # Shell state and history
    "\.zsh_history$"
    "\.zhistory$"
    "\.bash_history$"
    "\.zsh_sessions/"
    "\.bash_sessions/"
    "\.zcompdump"
    "\.zwc$"

    # Fish shell state
    "fish_variables$"
    "fish_history$"

    # Secrets and credentials
    "\.env$"
    "\.env\."
    "env\.[^/]*\.zsh$"  # env.local.zsh, env.secrets.zsh, etc.
    "\.secret$"
    "\.key$"
    "\.pem$"

    # Editor/IDE artifacts
    "\.swp$"
    "\.swo$"
    "\.vscode/"
    "\.idea/"
    "\.code-workspace$"

    # Language artifacts
    "__pycache__/"
    "\.pyc$"
    "\.pyo$"
    "node_modules/"
    "\.npm/"

    # Generic temp/backup
    "\.log$"
    "\.bak$"
    "\.tmp$"
    "~$"
)

# Get list of files staged for commit
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check each staged file against forbidden patterns
VIOLATIONS=()
for file in $STAGED_FILES; do
    for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            VIOLATIONS+=("$file")
            break
        fi
    done
done

# If violations found, block commit and show helpful message
if [ ${#VIOLATIONS[@]} -gt 0 ]; then
    echo -e "${RED}❌ COMMIT BLOCKED${NC}"
    echo -e "${RED}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}The following files should NOT be committed:${NC}"
    echo ""
    for violation in "${VIOLATIONS[@]}"; do
        echo -e "  ${RED}✗${NC} $violation"
    done
    echo ""
    echo -e "${YELLOW}These files are state/cache/history/secrets and violate the .gitignore policy.${NC}"
    echo ""
    echo "To fix this:"
    echo "  1. Unstage the file(s):  ${YELLOW}git restore --staged <file>${NC}"
    echo "  2. Remove from git:      ${YELLOW}git rm --cached <file>${NC}"
    echo "  3. Verify .gitignore:    Check that patterns match the file paths"
    echo ""
    echo "If these files were previously tracked, remove them with:"
    echo "  ${YELLOW}git rm --cached <file>${NC}"
    echo ""
    exit 1
fi

# All checks passed
exit 0
